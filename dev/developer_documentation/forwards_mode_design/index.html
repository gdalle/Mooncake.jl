<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Forwards-Mode Design · Mooncake.jl</title><meta name="title" content="Forwards-Mode Design · Mooncake.jl"/><meta property="og:title" content="Forwards-Mode Design · Mooncake.jl"/><meta property="twitter:title" content="Forwards-Mode Design · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body>
<!-- NAVBAR START -->
<style>
    html {
        scroll-padding-top: calc(55px + 1rem);
    }

    /* Documenter css tweaks */
    .docs-sidebar {
        margin-top: 3.75rem;
    }

    #documenter {
        margin-top: 3.75rem;
    }

    .docs-version-selector {
        margin-bottom: 60px !important;
    }

    @media screen and (max-width: 1056px) {
        .docs-version-selector {
            margin-bottom: 60px !important;
        }

        .docs-sidebar {
            margin-top: 0 !important;
        }
    }
    /* Documenter css tweaks ends here */

    :root {
        --heading-color: white;
        --item-color: rgb(165, 165, 165);
        --primary-bg: #073c44;
        --hover-color: #8faad2;
        --deprecated-bg: #ff4d4d;
        --deprecated-text: white;
    }

    .ext-navigation {
        position: fixed;
        height: 3.75rem;
        top: 0;
        width: 100%;
        background-color: var(--primary-bg);
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        padding: 0 1.0625rem;
        transition: transform 0.3s;
    }

    .ext-navbar-logo {
        margin-left: 0.625rem;
    }

    .ext-nav-links {
        display: flex;
        align-items: center;
        list-style-type: none;
        margin: 0;
        padding: 0;
        flex-grow: 1;
    }

    .ext-nav-links li {
        margin-left: 1rem !important;
    }

    .ext-nav-link {
        color: white !important;
        text-decoration: none;
        font-size: 1.0625rem !important;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .ext-nav-link:hover,
    .ext-navbar-item-single a:hover {
        color: var(--hover-color) !important;
    }

    .ext-navbar-item-single a {
        color: #fff !important;
    }

    .ext-menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: white;
        cursor: pointer;
    }

    .ext-dropdown {
        display: none;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        grid-template-rows: auto auto auto;
        padding: 1.875rem;
        position: absolute;
        width: 100%;
        left: 0;
        background-color: #083c44;
        line-height: 1.875rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(-0.625rem);
    }

    #library-handler::after {
        content: "▼";
        font-size: 0.6875rem;
        margin-left: 0.3125rem;
        transition: transform 0.3s ease-in-out;
    }

    #library-handler.open::after {
        content: "▲";
    }

    .ext-dropdown.show {
        display: grid;
        opacity: 1;
        transform: translateY(0);
    }

    .ext-dropdown ul {
        height: auto;
        width: 12.5rem;
        margin-bottom: 1.25rem;
    }

    .ext-dropdown ul li {
        text-align: left;
        display: flex;
        align-items: center;
    }

    .navbar-sub-item {
        list-style: none;
    }

    .ext-dropdown ul a li {
        color: var(--item-color);
        width: 15.625rem;
        border-radius: 3px;
        padding: 0.125rem 0.625rem;
        transition: background-color 0.2s ease;
    }

    .ext-dropdown ul a li:hover {
        background-color: rgba(107, 107, 107, 0.5);
    }

    .ext-dropdown-item-heading {
        color: var(--heading-color);
        text-align: center;
    }

    .deprecated-badge {
        background-color: var(--deprecated-bg);
        color: var(--deprecated-text);
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        margin-left: 0.5rem;
        line-height: 1;
    }

    /* Responsive styling */
    @media (max-width: 966px) {
        .ext-dropdown {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .ext-nav-links {
            display: none;
            flex-direction: column;
            width: 100%;
            background-color: var(--primary-bg);
            position: absolute;
            top: 3.75rem;
            left: 0;
            padding: 0.625rem 0;
            height: auto;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgb(141, 141, 141) grey;
        }

        .ext-nav-links.show {
            display: flex;
        }

        .ext-nav-links li {
            margin: 0.625rem 0;
            text-align: center;
        }

        .ext-menu-toggle {
            display: block;
            margin-left: auto;
        }

        .ext-navigation.hide {
            transform: translateY(-3.75rem);
        }

        .ext-dropdown {
            place-content: center;
            text-align: center;
            grid-template-columns: 1fr;
            line-height: 1.25rem;
            padding: 0.625rem;
        }

        .ext-dropdown ul {
            width: 100%;
            text-align: center;
            margin-bottom: 0.3125rem;
        }

        .ext-dropdown ul li {
            text-align: center;
            /* justify-content: center; */
        }

        .ext-dropdown ul a li {
            width: 100%;
        }

        .ext-dropdown ul a li:hover {
            background-color: var(--primary-bg);
            color: #fff;
        }

        /* Modified scroll bar */
        .ext-nav-links::-webkit-scrollbar {
            width: 5px;
        }

        .ext-nav-links::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px grey;
        }

        .ext-nav-links::-webkit-scrollbar-thumb {
            background: rgb(141, 141, 141);
            border-radius: 3px;
        }

        .ext-nav-links::-webkit-scrollbar-thumb:hover {
            background: #9b9b9b;
        }
    }
</style>
<nav class="ext-navigation">
    <a href="https://turinglang.org/">
        <img src="https://turinglang.org/assets/images/turing-logo.svg" alt="Turing Logo" class="ext-navbar-logo" height="24px" width="40px">
    </a>
    <a style="color: white !important; font-size: 21.25px !important; margin-left: 10px;" href="https://turinglang.org/">Turing.jl</a>
    <ul class="ext-nav-links">
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/docs-00-getting-started/">Get Started</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/00-introduction/">Tutorials</a>
        </li>
        <li>
            <p class="ext-nav-link" id="library-handler">Libraries</p>
            <div class="ext-dropdown" id="ext-dropdown-items">
                <ul>
                    <li class="ext-dropdown-item-heading">Modelling Languages</li>
                    <a href="https://turinglang.org/DynamicPPL.jl/">
                        <li>DynamicPPL</li>
                    </a>
                    <a href="https://turinglang.org/JuliaBUGS.jl/">
                        <li>JuliaBUGS</li>
                    </a>
                    <a href="https://turinglang.org/TuringGLM.jl/">
                        <li>TuringGLM</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">MCMC</li>
                    <a href="https://turinglang.org/AdvancedHMC.jl/">
                        <li>AdvancedHMC</li>
                    </a>
                    <a href="https://turinglang.org/AbstractMCMC.jl/">
                        <li>AbstractMCMC</li>
                    </a>
                    <a href="https://github.com/theogf/ThermodynamicIntegration.jl">
                        <li>ThermodynamicIntegration</li>
                    </a>
                    <a href="https://turinglang.org/AdvancedPS.jl/">
                        <li>AdvancedPS</li>
                    </a>
                    <a href="https://turinglang.org/SliceSampling.jl/">
                        <li>SliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/EllipticalSliceSampling.jl/">
                        <li>EllipticalSliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/NestedSamplers.jl/">
                        <li>NestedSamplers</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Diagnostics</li>
                    <a href="https://turinglang.org/MCMCChains.jl/">
                        <li>MCMCChains</li>
                    </a>
                    <a href="https://turinglang.org/MCMCDiagnosticTools.jl/">
                        <li>MCMCDiagnosticTools</li>
                    </a>
                    <a href="https://turinglang.org/ParetoSmooth.jl/">
                        <li>ParetoSmooth</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Gaussian Processes</li>
                    <a href="https://juliagaussianprocesses.github.io/AbstractGPs.jl/">
                        <li>AbstractGPs</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/KernelFunctions.jl/">
                        <li>KernelFunctions</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/ApproximateGPs.jl/">
                        <li>ApproximateGPs</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Bijectors.jl/">Bijectors</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/TuringCallbacks.jl/">TuringCallbacks</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Deprecated/TuringBenchmarking/">TuringBenchmarking</a>
                        <span class="deprecated-badge">Deprecated</span>
                    </li>
                </ul>
            </div>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/news/">News</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/team/">Team</a>
        </li>
    </ul>
    <a href="https://x.com/TuringLang" style="margin-left: 15px; padding-top: 2px">
        <svg fill="#ffffff" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="-209.92 -209.92 931.84 931.84" xml:space="preserve" stroke="#ffffff">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <g id="7935ec95c421cee6d86eb22ecd12f847">
                    <path style="display: inline"
                        d="M459.186,151.787c0.203,4.501,0.305,9.023,0.305,13.565 c0,138.542-105.461,298.285-298.274,298.285c-59.209,0-114.322-17.357-160.716-47.104c8.212,0.973,16.546,1.47,25.012,1.47 c49.121,0,94.318-16.759,130.209-44.884c-45.887-0.841-84.596-31.154-97.938-72.804c6.408,1.227,12.968,1.886,19.73,1.886 c9.55,0,18.816-1.287,27.617-3.68c-47.955-9.633-84.1-52.001-84.1-102.795c0-0.446,0-0.882,0.011-1.318 c14.133,7.847,30.294,12.562,47.488,13.109c-28.134-18.796-46.637-50.885-46.637-87.262c0-19.212,5.16-37.218,14.193-52.7 c51.707,63.426,128.941,105.156,216.072,109.536c-1.784-7.675-2.718-15.674-2.718-23.896c0-57.891,46.941-104.832,104.832-104.832 c30.173,0,57.404,12.734,76.525,33.102c23.887-4.694,46.313-13.423,66.569-25.438c-7.827,24.485-24.434,45.025-46.089,58.002 c21.209-2.535,41.426-8.171,60.222-16.505C497.448,118.542,479.666,137.004,459.186,151.787z">
                    </path>
                </g>
            </g>
        </svg>
    </a>
    <a href="https://github.com/TuringLang/Turing.jl">
        <svg width="32px" height="32px" viewBox="-8.2 -8.2 36.40 36.40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <title>github [#142]</title>
                <desc>Created with Sketch.</desc>
                <defs></defs>
                <g id="Page-1" stroke-width="0.0002" fill="none" fill-rule="evenodd">
                    <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#ffffff">
                        <g id="icons" transform="translate(56.000000, 160.000000)">
                            <path
                                d="M94,7399 C99.523,7399 104,7403.59 104,7409.253 C104,7413.782 101.138,7417.624 97.167,7418.981 C96.66,7419.082 96.48,7418.762 96.48,7418.489 C96.48,7418.151 96.492,7417.047 96.492,7415.675 C96.492,7414.719 96.172,7414.095 95.813,7413.777 C98.04,7413.523 100.38,7412.656 100.38,7408.718 C100.38,7407.598 99.992,7406.684 99.35,7405.966 C99.454,7405.707 99.797,7404.664 99.252,7403.252 C99.252,7403.252 98.414,7402.977 96.505,7404.303 C95.706,7404.076 94.85,7403.962 94,7403.958 C93.15,7403.962 92.295,7404.076 91.497,7404.303 C89.586,7402.977 88.746,7403.252 88.746,7403.252 C88.203,7404.664 88.546,7405.707 88.649,7405.966 C88.01,7406.684 87.619,7407.598 87.619,7408.718 C87.619,7412.646 89.954,7413.526 92.175,7413.785 C91.889,7414.041 91.63,7414.493 91.54,7415.156 C90.97,7415.418 89.522,7415.871 88.63,7414.304 C88.63,7414.304 88.101,7413.319 87.097,7413.247 C87.097,7413.247 86.122,7413.234 87.029,7413.87 C87.029,7413.87 87.684,7414.185 88.139,7415.37 C88.139,7415.37 88.726,7417.2 91.508,7416.58 C91.513,7417.437 91.522,7418.245 91.522,7418.489 C91.522,7418.76 91.338,7419.077 90.839,7418.982 C86.865,7417.627 84,7413.783 84,7409.253 C84,7403.59 88.478,7399 94,7399"
                                id="github-[#142]">
                            </path>
                        </g>
                    </g>
                </g>
            </g>
        </svg>
    </a>
    <span class="ext-menu-toggle">&#9776;</span>
</nav>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.querySelector(".ext-menu-toggle");
        const navLinks = document.querySelector(".ext-nav-links");
        const nav = document.querySelector(".ext-navigation");
        const navigationHandler = document.getElementById("library-handler");
        const navigationItemsContainer =
            document.getElementById("ext-dropdown-items");
        let lastScrollY = window.scrollY;

        function setAppropriateHeight() {
            if (window.innerWidth <= 768) {
                const viewportHeight = window.innerHeight;
                const navHeight = nav.offsetHeight;
                navLinks.style.maxHeight = `${viewportHeight - navHeight}px`;
                navLinks.style.overflowY = "auto";
            } else {
                navLinks.style.maxHeight = "";
                navLinks.style.overflowY = "";
            }
        }

        // Toggle main menu for mobile
        menuToggle.addEventListener("click", () => {
            navLinks.classList.toggle("show");
            if (navLinks.classList.contains("show")) {
                setAppropriateHeight();
                // Ensure the dropdown is hidden when menu is first opened
                navigationItemsContainer.style.display = "none";
                navigationItemsContainer.classList.remove("show");
            }
        });

        // Close menus if clicked outside
        document.addEventListener("click", (event) => {
            if (
                !navLinks.contains(event.target) &&
                !menuToggle.contains(event.target)
            ) {
                navLinks.classList.remove("show");
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
            }
        });

        // Hide navigation bar on scroll down in mobile view
        window.addEventListener("scroll", () => {
            if (window.innerWidth <= 768) {
                nav.classList.toggle("hide", window.scrollY > lastScrollY);
                lastScrollY = window.scrollY;
            }
        });

        // Library API script
        navigationHandler.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default action of the link
            if (navigationItemsContainer.classList.contains("show")) {
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
                setTimeout(() => {
                    navigationItemsContainer.style.display = "none";
                }, 500); // Match the timeout to the CSS transition duration
            } else {
                navigationItemsContainer.style.display = "grid";
                navigationHandler.classList.add("open");
                setTimeout(() => {
                    navigationItemsContainer.classList.add("show");
                }, 10); // Delay to ensure the display change takes effect before adding class
            }
            setAppropriateHeight(); // Recalculate height when dropdown changes
        });

        // Handle window resize
        window.addEventListener("resize", setAppropriateHeight);

        // Initial setup
        setAppropriateHeight();
    });
</script>
<!-- NAVBAR END -->

<div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../tangents/">Tangents</a></li><li><a class="tocitem" href="../custom_tangent_type/">Writing Custom Tangent Types</a></li><li><a class="tocitem" href="../ir_representation/">IR Representation</a></li><li class="is-active"><a class="tocitem" href>Forwards-Mode Design</a><ul class="internal"><li><a class="tocitem" href="#Forwards-Rule-Interface"><span>Forwards-Rule Interface</span></a></li><li><a class="tocitem" href="#Hand-Written-Rules"><span>Hand-Written Rules</span></a></li><li><a class="tocitem" href="#Derived-Rules"><span>Derived Rules</span></a></li><li><a class="tocitem" href="#Batch-Mode"><span>Batch Mode</span></a></li><li><a class="tocitem" href="#Forwards-vs-Reverse-Implementation"><span>Forwards vs Reverse Implementation</span></a></li><li><a class="tocitem" href="#Comparison-with-ForwardDiff.jl"><span>Comparison with ForwardDiff.jl</span></a></li></ul></li><li><a class="tocitem" href="../reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li class="is-active"><a href>Forwards-Mode Design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Forwards-Mode Design</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gdalle/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gdalle/Mooncake.jl/blob/main/docs/src/developer_documentation/forwards_mode_design.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Forwards-Mode-Design"><a class="docs-heading-anchor" href="#Forwards-Mode-Design">Forwards-Mode Design</a><a id="Forwards-Mode-Design-1"></a><a class="docs-heading-anchor-permalink" href="#Forwards-Mode-Design" title="Permalink"></a></h1><p><strong>Disclaimer</strong>: this document refers to an as-yet-unimplemented forwards-mode AD. This will disclaimer will be removed once it has been implemented.</p><p>The purpose of this document is to explain how forwards-mode AD in Mooncake.jl is implemented. It should do so to a sufficient level of depth to enable the interested reader to read to the forwards-mode AD code in Mooncake.jl and understand what is going on.</p><p>This document</p><ol><li>specifies the semantics of a &quot;rule&quot; for forwards-mode AD,</li><li>specifies how to implement rules by-hand for primitives,</li><li>specifies how to derive rules from <code>IRCode</code> algorithmically in general,</li><li>discusses batched forwards-mode,</li><li>discusses some notable technical differences between our forwards-mode AD implementation details and reverse-mode AD implementation details, and</li><li>concludes with a brief comparison with ForwardDiff.jl.</li></ol><h2 id="Forwards-Rule-Interface"><a class="docs-heading-anchor" href="#Forwards-Rule-Interface">Forwards-Rule Interface</a><a id="Forwards-Rule-Interface-1"></a><a class="docs-heading-anchor-permalink" href="#Forwards-Rule-Interface" title="Permalink"></a></h2><p>Loosely, a rule for a function simultaneously</p><ol><li>performs the same computation as the original function, and</li><li>computes the Frechet derivative.</li></ol><p>This is best explained through a worked example. Consider a function call</p><pre><code class="language-julia hljs">z = f(x, y)</code></pre><p>where <code>f</code> itself may contain data / state which is modified by executing <code>f</code>. <code>rule_for_f</code> is <em>some</em> callable which claims to be a forwards-rule for <code>f</code>. For <code>rule_for_f</code> to be a valid forwards-rule for <code>f</code>, it must be applicable to <code>Dual</code>s as follows:</p><pre><code class="language-julia hljs">z_dz = rule_for_f(Dual(f, df), Dual(x, dx), Dual(y, dy))::Dual</code></pre><p>where:</p><ol><li><code>rule_for_f</code> is a callable. It might be written by-hand, or derived algorithmically.</li><li><code>df</code>, <code>dx</code>, and <code>dy</code> are tangents for <code>f</code>, <code>x</code>, and <code>y</code> respectively. Before executing <code>rule_for_f</code>, they are inputs to the derivative of <code>(f, x, y)</code>. After executing they are outputs of this derivative.</li><li><code>z_dz</code> is a <code>Dual</code> containing the primal and the component of the derivative of <code>(f, x, y)</code> to <code>(df, dx, dy)</code> associated to <code>z</code>.</li><li>running <code>rule_for_f</code> leaves <code>f</code>, <code>x</code>, and <code>y</code> in the same state that running <code>f</code> does.</li></ol><p>We refer readers to <a href="../../understanding_mooncake/algorithmic_differentiation/#Algorithmic-Differentiation">Algorithmic Differentiation</a> to explain what we mean when we talk about the &quot;derivative&quot; above. We also discussed some worked examples shortly.</p><p>Note that <code>rule_for_f</code> is an as-yet-unspecified callable which we introduced purely to specify the interface that a forwards-rule must satisfy. In <a href="#Hand-Written-Rules">Hand-Written Rules</a> and <a href="#Derived-Rules">Derived Rules</a> below, we introduce two concrete ways to produce rules for <code>f</code>.</p><h3 id="Tangent-Types"><a class="docs-heading-anchor" href="#Tangent-Types">Tangent Types</a><a id="Tangent-Types-1"></a><a class="docs-heading-anchor-permalink" href="#Tangent-Types" title="Permalink"></a></h3><p>We will use the type system documented in <a href="../../understanding_mooncake/rule_system/#Representing-Gradients">Representing Gradients</a>. This means that every primal type has a unique tangent type. Moreover, if a <code>Dual</code> is defined as follows:</p><pre><code class="language-julia hljs">struct Dual{P, T}
    primal::P
    tangent::T
end</code></pre><p>it must always hold that <code>T = tangent_type(P)</code>.</p><h3 id="Testing"><a class="docs-heading-anchor" href="#Testing">Testing</a><a id="Testing-1"></a><a class="docs-heading-anchor-permalink" href="#Testing" title="Permalink"></a></h3><p>Suppose that we have (somehow) produced a supposed forwards-rule. To check that it is correctly implemented, we must ensure that</p><ol><li>all primal state after running the rule is approximately the same as all primal state after running the primal, and</li><li>the inner product between all tangents (both output and input) and a random tangent vector after running the rule is approximately the same as the estimate of the same quantity produced by finite differencing or reverse-mode AD.</li></ol><p>We already have the functionality to do this in a very general way (see <a href="../internal_docstrings/#Mooncake.TestUtils.test_rule-Tuple{Random.AbstractRNG, Vararg{Any}}"><code>Mooncake.TestUtils.test_rule</code></a>).</p><h2 id="Hand-Written-Rules"><a class="docs-heading-anchor" href="#Hand-Written-Rules">Hand-Written Rules</a><a id="Hand-Written-Rules-1"></a><a class="docs-heading-anchor-permalink" href="#Hand-Written-Rules" title="Permalink"></a></h2><p>Hand-written rules are implemented by writing methods of two functions: <code>is_primitive</code> and <code>frule!!</code>.</p><h3 id="is_primitive"><a class="docs-heading-anchor" href="#is_primitive"><code>is_primitive</code></a><a id="is_primitive-1"></a><a class="docs-heading-anchor-permalink" href="#is_primitive" title="Permalink"></a></h3><p><code>is_primitive(::Type{&lt;:Union{MinimalForwardsCtx, DefaultForwardsCtx}}, signature::Type{&lt;:Tuple})</code> should return <code>true</code> if AD must attempt to differentiate a call by passing the arguments to <code>frule!!</code>, and <code>false</code> otherwise. The <a href="../internal_docstrings/#Mooncake.@is_primitive-Tuple{Any, Any}"><code>Mooncake.@is_primitive</code></a> macro helps makes implementing this very easy.</p><h3 id="frule!!"><a class="docs-heading-anchor" href="#frule!!"><code>frule!!</code></a><a id="frule!!-1"></a><a class="docs-heading-anchor-permalink" href="#frule!!" title="Permalink"></a></h3><p>Methods of <code>frule!!</code> do the actual differentiation, and must satisfy the <a href="#Forwards-Rule-Interface">Forwards-Rule Interface</a> discussed above.</p><p>In what follows, we will refer to <code>frule!!</code>s for signatures. For example, the <code>frule!!</code> for signature <code>Tuple{typeof(sin), Float64}</code> is the rule which would differentiate calls like <code>sin(5.0)</code>.</p><h4 id="Simple-Scalar-Function"><a class="docs-heading-anchor" href="#Simple-Scalar-Function">Simple Scalar Function</a><a id="Simple-Scalar-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-Scalar-Function" title="Permalink"></a></h4><p>Recall that for <span>$y = \sin(x)$</span> we have that <span>$\dot{y} = \cos(x) \dot{x}$</span>. So the <code>frule!!</code> for signature <code>Tuple{typeof(sin), Float64}</code> is:</p><pre><code class="language-julia hljs">function frule!!(::Dual{typeof(sin)}, x::Dual{Float64})
    return Dual(sin(x.primal), cos(x.primal) * x.tangent)
end</code></pre><h4 id="Pre-allocated-Matrix-Matrix-Multiply"><a class="docs-heading-anchor" href="#Pre-allocated-Matrix-Matrix-Multiply">Pre-allocated Matrix-Matrix Multiply</a><a id="Pre-allocated-Matrix-Matrix-Multiply-1"></a><a class="docs-heading-anchor-permalink" href="#Pre-allocated-Matrix-Matrix-Multiply" title="Permalink"></a></h4><p>Recall that for <span>$Z = X Y$</span> we have that <span>$\dot{Z} = X \dot{Y} + \dot{X} Y$</span>. So the <code>frule!!</code> for signature <code>Tuple{typeof(mul!), Matrix{Float64}, Matrix{Float64}, Matrix{Float64}}</code> is:</p><pre><code class="language-julia hljs">function frule!!(
    ::Dual{typeof(LinearAlgebra.mul!)}, Z::Dual{P}, X::Dual{P}, Y::Dual{P}
) where {P&lt;:Matrix{Float64}}

    # Primal computation.
    mul!(Z.primal, X.primal, Y.primal)

    # Overwrite tangent of `z` to contain propagated tangent.
    mul!(Z.tangent, X.primal, Y.tangent)

    # Add the result of x.tangent * y.primal to `z.tangent`.
    mul!(Z.tangent, X.tangent, Y.primal, 0.0, 1.0) 
    return Z
end</code></pre><p>(In practice we would probably implement a rule for a lower-level function like <code>LinearAlgebra.BLAS.gemm!</code>, rather than <code>mul!</code>).</p><h2 id="Derived-Rules"><a class="docs-heading-anchor" href="#Derived-Rules">Derived Rules</a><a id="Derived-Rules-1"></a><a class="docs-heading-anchor-permalink" href="#Derived-Rules" title="Permalink"></a></h2><p>This is the &quot;automatic&quot; / &quot;algorithmic&quot; bit of AD! This is the second way of producing concrete callable objects which satisfy the <a href="#Forwards-Rule-Interface">Forwards-Rule Interface</a> discussed above. The object which we will ultimately construct is an instance <code>Mooncake.DerivedFRule</code>.</p><h4 id="Worked-Example:-Julia-Function"><a class="docs-heading-anchor" href="#Worked-Example:-Julia-Function">Worked Example: Julia Function</a><a id="Worked-Example:-Julia-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Worked-Example:-Julia-Function" title="Permalink"></a></h4><p>Before explaining how derived rules are produced algorithmically, we explain by way of example what a derived rule should look like if we work things through by hand.</p><p>A derived rule for a function such as</p><pre><code class="language-julia hljs">function f(x)
    y = g(x)
    z = h(x, y)
    return z
end</code></pre><p>should be something of the form</p><pre><code class="language-julia hljs">function rule_for_f(::Dual{typeof(f)}, x::Dual)
    y = rule_for_g(zero_dual(g), x)
    z = rule_for_h(zero_dual(h), x, y)
    return z
end</code></pre><p>Observe that the transformation is simply</p><ol><li>replace all variables with <code>Dual</code> variables,</li><li>replace all constants (e.g. <code>g</code> and <code>h</code>) with constant <code>Dual</code>s,</li><li>replace all calls with calls to rules.</li></ol><p>In general, all control flow should be identical between primal and rule.</p><h4 id="Worked-Example:-IRCode"><a class="docs-heading-anchor" href="#Worked-Example:-IRCode">Worked Example: IRCode</a><a id="Worked-Example:-IRCode-1"></a><a class="docs-heading-anchor-permalink" href="#Worked-Example:-IRCode" title="Permalink"></a></h4><p>The above example is expressed in terms of Julia code, but we will be operating on Julia <code>Compiler.IRCode</code>, so it is helpful to consider how the above example translates into this form. If we call <code>f</code> on a <code>Float64</code>, and suppose that <code>g</code> and <code>h</code> both return <code>Float64</code>s, the primal <code>Compiler.IRCode</code> will look something like the following:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode_by_type(Tuple{typeof(f), Float64})
1-element Vector{Any}:
2 1 ─ %1 = invoke Main.g(_2::Float64)::Float64
3 │   %2 = invoke Main.h(_2::Float64, %1::Float64)::Float64
4 └──      return %2
   =&gt; Float64</code></pre><p>Recall that <code>_2</code> is the second argument, in this case a <code>Float64</code>, and <code>%1</code> and <code>%2</code> are <code>SSAValue</code>s. Roughly speaking, the forwards-mode IR for the (ficiticious) function <code>rule_for_f</code> should look something like:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode_by_type(Tuple{typeof(rule_for_f), Dual{typeof(f), NoTangent}, Dual{Float64, Float64}})
1-element Vector{Any}:
2 1 ─ %1 = invoke rule_for_g($(Dual(Main.g, NoTangent())), _3::Dual{Float64, Float64})::Dual{Float64, Float64}
3 │   %2 = invoke rule_for_h($(Dual(Main.h, NoTangent())), _3::Dual{Float64, Float64}, %1::Dual{Float64, Float64})::Dual{Float64, Float64}
4 └──      return %2
   =&gt; Dual{Float64, Float64}</code></pre><p>Observe that:</p><ol><li>All <code>Argument</code>s have been incremented by <code>1</code>. i.e. <code>_2</code> has been replaced with <code>_3</code>. This corresponds to the fact that the arguments to the rule have all been shuffled along by one, and the rule itself is now the first argument.</li><li>Everything has been turned into a <code>Dual</code>.</li><li>Constants such as <code>Dual(Main.g, NoTangent())</code> appear directly in the code (here as <code>QuoteNode</code>s).</li></ol><p>(In practice it might be that we actually construct the <code>Dual</code>ed constants on the lines immediately preceding a call and rely on the compiler to optimise them back into the call directly).</p><p>Here, as before, we have not specified exactly what <code>rule_for_f</code>, <code>rule_for_g</code>, and <code>rule_for_h</code> are. This is intentional – they are just callables satisfying the <a href="#Forwards-Rule-Interface">Forwards-Rule Interface</a>. In the following we show how to derive <code>rule_for_f</code>, and show how <code>rule_for_g</code> and <code>rule_for_h</code> might be methods of <code>Mooncake.frule!!</code>, or themselves derived rules.</p><h4 id="Rule-Derivation-Outline"><a class="docs-heading-anchor" href="#Rule-Derivation-Outline">Rule Derivation Outline</a><a id="Rule-Derivation-Outline-1"></a><a class="docs-heading-anchor-permalink" href="#Rule-Derivation-Outline" title="Permalink"></a></h4><p>Equipped with some intuition about what a derived rule ought to look like, we examine how we go about producing it algorithmically.</p><p>Rule derivation is implemented via the function <code>Mooncake.build_frule</code>. This function accepts as arguments a context and a signature / <code>Base.MethodInstance</code> / <code>MistyClosure</code> and, roughly speaking, does the following:</p><ol><li>Look up the optimised <code>Compiler.IRCode</code>.</li><li>Apply a series of standardising transformations to the <code>IRCode</code>.</li><li>Transform each statement according to a set of rules to produce a new <code>IRCode</code>.</li><li>Apply standard Julia optimisations to this new <code>IRCode</code>.</li><li>Put this code inside a <code>MistyClosure</code> in order to produce an executable object.</li><li>Wrap this <code>MistyClosure</code> in a <code>DerivedFRule</code> to handle various bits of book-keeping around varargs.</li></ol><p>In order:</p><h4 id="Looking-up-the-Compiler.IRCode."><a class="docs-heading-anchor" href="#Looking-up-the-Compiler.IRCode.">Looking up the <code>Compiler.IRCode</code>.</a><a id="Looking-up-the-Compiler.IRCode.-1"></a><a class="docs-heading-anchor-permalink" href="#Looking-up-the-Compiler.IRCode." title="Permalink"></a></h4><p>This is done using <code>Mooncake.lookup_ir</code>. This function has methods with will return the <code>IRCode</code> associated to:</p><ol><li>signatures (e.g. <code>Tuple{typeof(f), Float64}</code>)</li><li><code>Base.MethodInstances</code> (relevant for <code>:invoke</code> expressions – see <a href="#Statement-Transformation">Statement Transformation</a> below)</li><li><code>MistyClosures.MistyClosure</code> objects, which is essential when computing higher order derivatives and Hessians by applying Mooncake.jl to itself.</li></ol><h4 id="Standardisation"><a class="docs-heading-anchor" href="#Standardisation">Standardisation</a><a id="Standardisation-1"></a><a class="docs-heading-anchor-permalink" href="#Standardisation" title="Permalink"></a></h4><p>We apply the following transformations to the Julia IR. They can all be found in <code>ir_normalisation.jl</code>:</p><ol><li><a href="../internal_docstrings/#Mooncake.foreigncall_to_call-Tuple{Any, Dict{Symbol, Core.Compiler.VarState}}"><code>Mooncake.foreigncall_to_call</code></a>: convert <code>Expr(:foreigncall, ...)</code> expressions into <code>Expr(:call, Mooncake._foreigncall_, ...)</code> expressions.</li><li><a href="../internal_docstrings/#Mooncake.new_to_call-Tuple{Any}"><code>Mooncake.new_to_call</code></a>: convert <code>Expr(:new, ...)</code> expressions to <code>Expr(:call, Mooncake._new_, ...)</code> expressions.</li><li><a href="../internal_docstrings/#Mooncake.splatnew_to_call-Tuple{Any}"><code>Mooncake.splatnew_to_call</code></a>: convert <code>Expr(:splatnew, ...)</code> expressions to <code>Expr(:call, Mooncake._splat_new_...)</code> expressions.</li><li><a href="../internal_docstrings/#Mooncake.intrinsic_to_function-Tuple{Any}"><code>Mooncake.intrinsic_to_function</code></a>: convert <code>Expr(:call, ::IntrinsicFunction, ...)</code> to calls to the corresponding function in <a href="../internal_docstrings/#Mooncake.IntrinsicsWrappers">Mooncake.IntrinsicsWrappers</a>.</li></ol><p>The purpose of converting <code>Expr(:foreigncall...)</code>, <code>Expr(:new, ...)</code> and <code>Expr(:splatnew, ...)</code> into <code>Expr(:call, ...)</code>s is to enable us to differentiate such expressions by adding methods to <code>frule!!(::Dual{typeof(Mooncake._foreigncall_)})</code>, <code>frule!!(::Dual{typeof(Mooncake._new_)})</code>, and <code>frule!!(::Dual{typeof(Mooncake._splat_new_)})</code>, in exactly the same way that we would for any other regular Julia function.</p><p>The purpose of translating <code>Expr(:call, ::IntrinsicFunction, ...)</code> is to do with type stability – see the docstring for the <a href="../internal_docstrings/#Mooncake.IntrinsicsWrappers">Mooncake.IntrinsicsWrappers</a> module for more info.</p><h4 id="Statement-Transformation"><a class="docs-heading-anchor" href="#Statement-Transformation">Statement Transformation</a><a id="Statement-Transformation-1"></a><a class="docs-heading-anchor-permalink" href="#Statement-Transformation" title="Permalink"></a></h4><p>Each statment which can appear in the Julia IR is transformed by a method of <code>Mooncake.make_fwds_ad_stmts</code>. Consequently, this transformation phase simply corresponds to iterating through all of the expressions in the <code>IRCode</code>, applying <code>Mooncake.make_fwd_ad_stmts</code> to each to produce new <code>IRCode</code>. To understand how to modify <code>IRCode</code> and insert new instructions, see <a href="https://gist.github.com/oxinabox/cdcffc1392f91a2f6d80b2524726d802">Oxinabox&#39;s Gist</a>.</p><p>We provide here a high-level summary of the transformations for the most important Julia IR statements, and refer readers to the methods of <code>Mooncake.make_fwds_ad_stmts</code> for the definitive explanation of what transformation is applied, and the rationale for applying it. In particular there are quite a number more statements which can appear in Julia IR than those listed here and, for those we do list here, there are typically a few edge cases left out.</p><p><strong><code>Expr(:invoke, method_instance, f, x...)</code> and <code>Expr(:call, f, x...)</code></strong></p><p><code>:call</code> expressions correspond to <em>dynamic</em> dispatch, while <code>:invoke</code> expressions correspond to <em>static</em> dispatch. That is, if you see an <code>:invoke</code> expression, you know for sure that the compiler knows enough information about the types of <code>f</code> and <code>x</code> to prove exactly which specialisation of which method to call. This specialisation is <code>method_instance</code>. This typically happens when the compiler is able to prove the types of <code>f</code> and <code>x</code>. Conversely, a <code>:call</code> expression typically occurs when the compiler has not been able to deduce the exact types of <code>f</code> and <code>x</code>, and therefore not been able to figure out what to call. It therefore has to wait until runtime to figure out what to call, resulting in dynamic dispatch.</p><p>As we saw earlier, the idea is to translate these kinds of expressions into something vaguely along the lines of</p><pre><code class="language-julia hljs">Expr(:call, rule_for_f, f, x...)</code></pre><p>There are three cases to consider, in order of preference:</p><p>Primitives:</p><p>If <code>is_primitive</code> returns <code>true</code> when applied to the signature constructed from the static types of <code>f</code> and <code>x</code>, then we simply replace the expression with <code>Expr(:call, frule!!, f, x...)</code>, regardless whether we have an <code>:invoke</code> or <code>:call</code> expression. (Due to the <a href="#Standardisation">Standardisation</a> steps, it regularly happens that we see <code>:call</code> expressions in which we actually do know enough type information to do this, e.g. for <code>Mooncake._new_</code> <code>:call</code> expressions).</p><p>Static Dispatch:</p><p>In the case of <code>:invoke</code> nodes we know for sure at rule compilation time what <code>rule_for_f</code> must be. We derive a rule for the call by passing <code>method_instance</code> to <code>Mooncake.build_frule</code>. (In practice, we might do this lazily, but while retaining enough information to maintain type stability. See the <code>Mooncake.LazyDerivedRule</code> for how this is handled in reverse-mode).</p><p>Dynamic Dispatch:</p><p>If we have a <code>:call</code> expression and are not able to prove that <code>is_primitive</code> will return <code>true</code>, we must defer dispatch until runtime. We do this by replacing the <code>:call</code> expression with a call to a <code>DynamicFRule</code>, which simply constructs (or retrieves from a cache) the rule at runtime. Reverse-mode utilises a similar strategy via <code>Mooncake.DynamicDerivedRule</code>.</p><p>The above was written in terms of <code>f</code> and <code>x</code>. In practice, of course, we encounter various kinds of constants (e.g. <code>Base.sin</code>), <code>Argument</code>s (e.g. <code>_3</code>), and <code>Core.SSAValue</code>s (e.g. <code>%5</code>). The translation rules for these are:</p><ol><li>constants are turned into constant duals in which the tangent is zero,</li><li><code>Arguments</code> are incremented by <code>1</code>.</li><li><code>SSAValue</code>s are left as-is.</li></ol><p><strong><code>Core.GotoNode</code>s</strong></p><p>These remain entirely unchanged.</p><p><strong><code>Core.GotoIfNot</code></strong></p><p>These require minor modification. Suppose that a <code>Core.GotoIfNot</code> of the form <code>Core.GotoIfNot(%5, 4)</code> is encountered in the primal. Since <code>%5</code> will be a <code>Dual</code> in the derived rule, we must pull out the <code>primal</code> field, and pass that to the conditional instead. Therefore, these statments get lowered to two lines in the derived rule. For example, <code>Core.GotoIfNot(%5, 4)</code> would be translated to:</p><pre><code class="language-julia hljs">%n = getfield(%5, :primal)
Core.GotoIfNot(%n, 4)</code></pre><p><strong><code>Core.PhiNode</code></strong></p><p><code>Core.PhiNode</code> looks something like the following in the general case:</p><pre><code class="language-julia hljs">φ (#1 =&gt; %3, #2 =&gt; _2, #3 =&gt; 4, #4 =&gt; #undef)</code></pre><p>They map from a collection of basic block numbers (<code>#1</code>, <code>#2</code>, etc) to values. The values can be <code>Core.Argument</code>s, <code>Core.SSAValue</code>s, constants (literals and <code>QuoteNode</code>s), or undefined.</p><p><code>Core.PhiNode</code>s in the primal are mapped to <code>Core.PhiNode</code>s in the rule. They contain exactly the same basic block numbers, and apply the following translation rules to the values:</p><ol><li><code>Core.SSAValue</code>s are unchanged.</li><li><code>Core.Argument</code>s are incremented by <code>1</code> (as always).</li><li>constants are translated into constant duals.</li><li>undefined values remain undefined.</li></ol><p>So the above example would be translated into something like</p><pre><code class="language-julia hljs">φ (#1 =&gt; %3, #2 =&gt; _3, #3 =&gt; $(CoDual(4, NoTangent())), #4 =&gt; #undef)</code></pre><h4 id="Optimisation"><a class="docs-heading-anchor" href="#Optimisation">Optimisation</a><a id="Optimisation-1"></a><a class="docs-heading-anchor-permalink" href="#Optimisation" title="Permalink"></a></h4><p>The IR generated in the previous step will typically be uninferred, and suboptimal in a variety of ways. We fix this up by running inference and optimisation on the generated <code>IRCode</code>. This is implemented by <a href="../internal_docstrings/#Mooncake.optimise_ir!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.optimise_ir!</code></a>.</p><h4 id="Put-IRCode-in-MistyClosure"><a class="docs-heading-anchor" href="#Put-IRCode-in-MistyClosure">Put IRCode in MistyClosure</a><a id="Put-IRCode-in-MistyClosure-1"></a><a class="docs-heading-anchor-permalink" href="#Put-IRCode-in-MistyClosure" title="Permalink"></a></h4><p>Now that we have an optimised <code>IRCode</code> object, we need to turn it into something that can actually be run. This can, in general, be straightforwardly achieved by putting it inside a <code>Core.OpaqueClosure</code>. This works, but <code>Core.OpaqueClosure</code>s have the disadvantage that once you&#39;ve constructed a <code>Core.OpaqueClosure</code> using an <code>IRCode</code>, it is not possible to get it back out. Consequently, we use <code>MistyClosure</code>s, in order to keep the <code>IRCode</code> readily accessible if we want to access it later.</p><h4 id="Put-the-MistyClosure-in-a-DerivedFRule"><a class="docs-heading-anchor" href="#Put-the-MistyClosure-in-a-DerivedFRule">Put the MistyClosure in a DerivedFRule</a><a id="Put-the-MistyClosure-in-a-DerivedFRule-1"></a><a class="docs-heading-anchor-permalink" href="#Put-the-MistyClosure-in-a-DerivedFRule" title="Permalink"></a></h4><p>See the implementation of <code>DerivedRule</code> (used in reverse-mode) for more context on this. <em>This</em> is the &quot;rule&quot; that users get.</p><h2 id="Batch-Mode"><a class="docs-heading-anchor" href="#Batch-Mode">Batch Mode</a><a id="Batch-Mode-1"></a><a class="docs-heading-anchor-permalink" href="#Batch-Mode" title="Permalink"></a></h2><p>So far, we have assumed that we would only apply forwards-mode to a single tangent vector at a time. However, in practice, it is typically best to pass a collection of tangents through at a time.</p><p>In order to do this, all of the transformation code listed above can remain the same, we will just need to devise a system of &quot;batched tangents&quot;. Then, instead of propagating a &quot;primal-tangent&quot; pairs via <code>Dual</code>s, we propagate primal-tangent_batch pairs (perhaps also via <code>Dual</code>s).</p><h2 id="Forwards-vs-Reverse-Implementation"><a class="docs-heading-anchor" href="#Forwards-vs-Reverse-Implementation">Forwards vs Reverse Implementation</a><a id="Forwards-vs-Reverse-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Forwards-vs-Reverse-Implementation" title="Permalink"></a></h2><p>The implementation of forwards-mode AD is quite dramatically simpler than that of reverse-mode AD. Some notable technical differences include:</p><ol><li>forwards-mode AD only makes use of the tangent system, whereas reverse-mode also makes use of the fdata / rdata system.</li><li>forwards-mode AD comprises only line-by-line transformations of the <code>IRCode</code>. In particular, it does not require the insertion of additional basic blocks, nor the modification of the successors / predecessors of any given basic block. Consequently, there is no need to make use of the <code>BBCode</code> infrastructure built up for reverse-mode AD – everything can be straightforwardly done at the <code>Compiler.IRCode</code> level.</li></ol><h2 id="Comparison-with-ForwardDiff.jl"><a class="docs-heading-anchor" href="#Comparison-with-ForwardDiff.jl">Comparison with ForwardDiff.jl</a><a id="Comparison-with-ForwardDiff.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-with-ForwardDiff.jl" title="Permalink"></a></h2><p>With reference to <a href="https://juliadiff.org/ForwardDiff.jl/stable/user/limitations/#Limitations-of-ForwardDiff">the limitations of ForwardDiff.jl</a>, there are a few noteworthy differences between ForwardDiff.jl and this implementation:</p><ol><li><code>:foreigncall</code>s pose much less of a problem for Mooncake&#39;s forward-mode than for ForwardDiff.jl, because we can write a rule for any method of any function. In essence, you can only (reliably) write rules for ForwardDiff.jl via dispatch on <code>ForwardDiff.Dual</code>.</li><li>the target function can be of any arity in Mooncake.jl, but must be unary in ForwardDiff.jl.</li><li>there are no limitations on the argument type constraints that Mooncake.jl can handle, while ForwardDiff.jl requires that argument type constraints be <code>&lt;:Real</code> or arrays of <code>&lt;:Real</code>.</li><li>No special storage types are required with Mooncake.jl, while ForwardDiff.jl requires that any container you write to is able to contain <code>ForwardDiff.Dual</code>s.</li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ir_representation/">« IR Representation</a><a class="docs-footer-nextpage" href="../reverse_mode_design/">Reverse-Mode Design »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Tuesday 24 June 2025 16:19">Tuesday 24 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
